## I am going to try this very nice package.
## Check this website: http://ropensci.org/blog/2014/04/22/rwbclimate-sp/
## library(devtools)
## devtools::install_github("spocc", "ropensci")

library(geiger)
library(spocc)
library(maptools)
library(raster)
library(plyr)
library(phytools)
library(phylolm)

load("data.Rdata")

phy <- read.nexus("1741-7007-10-12-s5.nex")[[1]]
sp.total <- phy$tip.label
## Take out the outgroup species.
sp <- sp.total[which(!sp.total %in% c("Equus_caballus","Bos_taurus","Artibeus_jamaicensis"
                                     ,"Mystacina_tuberculata","Tadarida_brasiliensis","Homo_sapiens"
                                     ,"Rattus_norvegicus","Mus_musculus"))]

## Get occurrence data for the species:
dt <- occ(query = sp, from = c("gbif"), limit = 100)
dtfix <- fixnames(dt, how = "query")
dt.df <- occ2df(dtfix)
head(dt.df) ## Nice!
dim(dt.df)

## Plot to see where the species are:
data(wrld_simpl)
## plot(wrld_simpl, col = "light yellow", axes = T)
## points(dt.df$longitude, dt.df$latitude, col = "red", cex = 0.25)

## Get climate data:

## Data downloaded from: http://biogeo.ucdavis.edu/
## Using the 2-5m (accuracy) bio_clim data.

## BIO1 = Annual Mean Temperature (amT)
## BIO2 = Mean Diurnal Range (Mean of monthly (max temp - min temp)) (mdrT)
## BIO3 = Isothermality (BIO2/BIO7) (* 100) (isoT)
## BIO4 = Temperature Seasonality (standard deviation *100) (Tseas)
## BIO5 = Max Temperature of Warmest Month (TmaxWM)
## BIO6 = Min Temperature of Coldest Month (TminCM)
## BIO7 = Temperature Annual Range (BIO5-BIO6) (Tar)
## BIO8 = Mean Temperature of Wettest Quarter (TmeanWeQ)
## BIO9 = Mean Temperature of Driest Quarter (TmeanDQ)
## BIO10 = Mean Temperature of Warmest Quarter (TmeanWaQ)
## BIO11 = Mean Temperature of Coldest Quarter (TmeanCQ)
## BIO12 = Annual Precipitation (aP)
## BIO13 = Precipitation of Wettest Month (PWeM)
## BIO14 = Precipitation of Driest Month (PDM)
## BIO15 = Precipitation Seasonality (Coefficient of Variation) (Pseas)
## BIO16 = Precipitation of Wettest Quarter (PWeQ)
## BIO17 = Precipitation of Driest Quarter (PDQ)
## BIO18 = Precipitation of Warmest Quarter (PWaQ)
## BIO19 = Precipitation of Coldest Quarter (PCQ)

nms <- c("amT","mdrT","isoT","Tseas","TmaxWM","TminCM","Tar","TmeanWeQ","TmeanDQ","TmeanWaQ","TmeanCQ","aP"
         ,"PWeM","PDM","Pseas","PWeQ","PDQ","PWaQ","PCQ")
index <- 1:19

climate <- stack()
for(i in index){
    r <- raster(paste("~/Documents/Academicos/Harmon_Lab/Projects/PhyloPCA_paper/bio_2-5m_bil/bio",index[i]
                      ,".bil",sep = ""))
    climate <- stack(climate, r)
}
nlayers(climate)

## plot(climate@layers[[12]], main = nms[12]) ## Annual Precipitation plot.
## points(dt.df$longitude, dt.df$latitude, col = "red", cex = 0.25)

## Extract the bioclimate data for each occurrence:
bioclim <- extract(climate, dt.df[,2:3], method='simple', df=TRUE)
bioclim <- bioclim[,-1]
names(bioclim) <- c(nms)

biobuff <- extract(climate, dt.df[,2:3], method='simple', buffer=500, fun=mean, df=TRUE)
## This will get the climate data for a 5km radius, then give the mean for each point.

## Make data.frame with everything:
bio.dt <- data.frame(species=dt.df$name,bioclim)
names(bio.dt)

## Get mean bioclimate data by species:
mean.c <- colwise(mean, na.rm = TRUE)
bio.mean <- ddply(bio.dt, "species", function(x) mean.c(x) )

## Adjust and log-transform:
apply(bio.mean[,-1], 2, function(x) min(x, na.rm = TRUE)) # Find negative values

bio.mean.p <- bio.mean

bio.mean.p$amT <- bio.mean.p$amT + 81
bio.mean.p$TminCM <- bio.mean.p$TminCM + 332
bio.mean.p$TmeanDQ <- bio.mean.p$TmeanDQ + 194
bio.mean.p$TmeanCQ <- bio.mean.p$TmeanCQ + 278
bio.mean.p$PDM <- bio.mean.p$PDM + 1
bio.mean.p$PDQ <- bio.mean.p$PDQ + 1
bio.mean.p$PWaQ <- bio.mean.p$PWaQ + 1
bio.mean.p$PCQ <- bio.mean.p$PCQ + 1

## Double check:
names(bio.mean.p)
apply(bio.mean.p[,-1], 2, function(x) max(x, na.rm = TRUE))
apply(bio.mean.p[,-1], 2, function(x) min(x, na.rm = TRUE))

## Log transform:
bio.log <- apply(bio.mean.p[,-1], 2, log)
bio.log <- data.frame(species=bio.mean.p$species, bio.log)
names(bio.log)
dim(bio.log) == dim(bio.mean.p)

## Take out NaN species:
ss <- apply(bio.log[,-1], 2, function(x) which(x == "NaN") )
ss[,1]
bio.log <- bio.log[-ss[,1],]

## Drop tips that are not in the dataset:
bio.log$species <- gsub(" ", "_", bio.log$species)
phy.car <- drop.tip(phy, tip = phy$tip.label[which(!phy$tip.label %in% bio.log[,1])])
mm <- match(phy.car$tip.label, bio.log[,1])
rownames(bio.log) <- bio.log$species ## phyl.pca requirement.
bio.log <- bio.log[,-1]

## Find PCs and Phylogenetic PCs.
is.binary.tree(phy.car)
phy.car <- multi2di(phy.car)

pc <- princomp(bio.log)
ppc <- phyl.pca(phy.car, bio.log)

#################################################################################

## Fitting the models with log-transformation:
models <- c("BM", "OUrandomRoot", "EB")
rawfits <- list()
pcfits <- list()
ppcfits <- list()

index <- 1:dim(bio.log)[2]

for(i in 1:length(models)){
    rawfits[[i]] <- lapply(index, function(x) phylolm(bio.log[,x]~1, phy=phy.car, model=models[i]))
    pcfits[[i]] <-  lapply(index, function(x) phylolm(pc$scores[,x]~1, phy=phy.car, model=models[i]))
    ppcfits[[i]] <-  lapply(index, function(x) phylolm(ppc$S[,x]~1, phy=phy.car, model=models[i]))
}

## Get the AICw:
bm.aic <- lapply(index, function(x) (c(rawfits[[1]][[x]]$aic, pcfits[[1]][[x]]$aic, ppcfits[[1]][[x]]$aic)))
ou.aic <- lapply(index, function(x) (c(rawfits[[2]][[x]]$aic, pcfits[[2]][[x]]$aic, ppcfits[[2]][[x]]$aic)))
eb.aic <- lapply(index, function(x) (c(rawfits[[3]][[x]]$aic, pcfits[[3]][[x]]$aic, ppcfits[[3]][[x]]$aic)))
all.aicw <- lapply(index, function(x) lapply(1:3, function(y) aicw(c(bm.aic[[x]][y]
                                                                     , ou.aic[[x]][y], eb.aic[[x]][y]))$w))

## Make result tables:
bm.table <- sapply(all.aicw, function(x) sapply(x, function(y) y[1]))
ou.table <- sapply(all.aicw, function(x) sapply(x, function(y) y[2]))
eb.table <- sapply(all.aicw, function(x) sapply(x, function(y) y[3]))
rownames(bm.table) <- rownames(ou.table) <- rownames(eb.table) <- c("raw","pc","ppc")

## Plots:
pdf("Carnivora_2-5_bioclim.pdf")
par(mfrow = c(3,3))
for(i in 1:3){
    plot(index, bm.table[i,], main = paste(models[1],rownames(bm.table)[i],sep="_")
         , ylim = c(0.0,1.0), ylab = "AICw", xlab = "PCs")
    plot(index, ou.table[i,], main = paste(models[2],rownames(ou.table)[i],sep="_")
         , ylim = c(0.0,1.0), ylab = "AICw", xlab = "PCs")
    plot(index, eb.table[i,], main = paste(models[3],rownames(eb.table)[i],sep="_")
         , ylim = c(0.0,1.0), ylab = "AICw", xlab = "PCs")
}
dev.off()

### --- ### --- ### --- ### --- ### --- ### --- ### --- ### --- ###
## Some graphs to visualize the data:

par(mfrow = c(3,4))
for(i in 1:12){
    r <- bio.log[,i]
    names(r) <- rownames(bio.log)
    phenogram(phy.car, r)
}
dev.copy2pdf()

par(mfrow = c(3,4))
for(i in 1:12){
    phenogram(phy.car, pc$scores[,i])
}
dev.copy2pdf()

par(mfrow = c(3,4))
for(i in 1:12){
    phenogram(phy.car, ppc$S[,i])
}
dev.copy2pdf()

## Seems reasonable that OU is the best model. Note how, given the number of species, the trait values are clustered.

## Check the likelihood of fit continuous:

r <- bio.log[,1]
names(r) <- rownames(bio.log)
bm <- fitContinuous(phy.car, r, model = "BM")
bm$opt$aic
ou <- fitContinuous(phy.car, r, model = "OU")
ou$opt$aic
eb <- fitContinuous(phy.car, r, model = "EB")
eb$opt$aic

## Check AICw:
aics <- c(bm$opt$aicc, ou$opt$aicc, eb$opt$aicc)
names(aics) <- c("bm","ou","eb")
aics <- aics[order(aics)]

w <- vector()
for(i in 1:3){
    delta <- aics[i] - aics[1]
    w[i] <- exp(-0.5 * delta)
}

aicw <- vector()
for(i in 1:3){
    aicw[i] <- w[i]/sum(w)
}

names(aics)
aicw
aics
